<html>
	<head>
	<title>network-graph</title>
	<script src="/socket.io/socket.io.js" type='text/javascript'></script>
	<script src="/jquery.js" type="text/javascript"></script>
	<script src="/jquery.ui.js" type="text/javascript"></script>
	<link type="text/css" href="/jquery.ui.css" rel="stylesheet" />
	<script type='text/javascript'>
		function showMessage( msg ){
			$("#message").html( msg + "<br>\n" );
		}

		function debug( msg ){
			msg = msg.replace( /</, '&lt;' ).replace( />/, '&gt;' );
			$("#debug").append( msg + "<br>\n" );
		}

		$(document).ready( function( ){

			var pcapSessionStarted	= false;

			var socket	= new io.Socket( null, { port: 8080, rememberTransport: false } );

			showMessage( "Connecting to socket.. " );
			socket.connect( );

			socket.on( 'connect', function( ){
				showMessage( "Connected to socket.." );
			} );

			socket.on( 'message', function( obj ){
				// Request/response
				if( typeof obj.request != 'undefined' ){
					parseRequestResponse( obj );

				// packets
				}else if( typeof obj.packet != 'undefined' ){
					debug( "Got packet with packetTime of '" + obj.packetTime + "'. '" + obj.packetSaddr + "'->'" + obj.packetDaddr + "'" );
	
				// Something else
				}else{
					debug( "Got unknown message of '" + obj.toString() + "'" );
				}
			} );

			socket.on( 'disconnect', function( ){
				showMessage( "Disconnected from socket.." );
			} );

			function parseRequestResponse( objToParse ){
				debug( "Parsing request of '" + objToParse.request + "'" );
				if( typeof objToParse.response == 'undefined' ){
					if( objToParse.request == 'filter' ){
						$("#filter-diag").dialog( "open" );
					}else{
						debug( "Unknown request made for '" + objToParse.request + "'" );
					}
				}else{
					// Response
				}
			}

			$("#filter-diag").dialog({
				autoOpen: false,
				height: 200,
				width: 400,
				modal: true,
				position: top,
				buttons: {
					"Set filter": function( ){
						socket.send( [ { request: 'filter', response: $("#filter").val() } ] );
						$(this).dialog( "close" );
						startPcap( );
					}
				}
			} );

			if( !pcapSessionStarted ){
				$("#graph").html( 'The pcap session has not been started.' );
			}
			
			function startPcap( ){
				debug( "Sending startPcap message to server.." );
				socket.send( [ { request: 'startPcap' } ] );
				pcapSessionStarted	= true;

				$("#graph").html( 'The pcap session has been started..' );
			}
		});
	</script>
	<style type='text/css'>
		body {
			font-family: Arial;	
		}
		#body {
			margin-left: 20px;
		}
		#message {
			border: 2px solid #ccc;
			font-weight: bold;
			font-size: 120%;
			margin: 10px;
			padding: 5px;
		}
		#filter-diag {
			background-color: #eee;
		}
		#debug {
			border: 2px solid #ccc;
			margin: 10px;
			padding: 5px;
			font-size: 60%;
		}
	</style>
<body>
	<h1>network-graph</h1>
	<div id='body'>
		<div id='message'></div>
		<div id='graph' style='width: 800px;height: 250px;'></div>
		<div id='filter-diag' title='Set filter'>
			<form>
				Filter: <input type="text" name="filter" id="filter" />
			</form>
		</div>
		<div id='debug'></div>
	</div>
</body>
</html>
