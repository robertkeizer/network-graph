<html>
	<head>
		<title>network-graph</title>
		<script src="/socket.io/socket.io.js" type='text/javascript'></script>
	</head>
<body>
	<script type='text/javascript'>
		function message( obj ){
			var e1 = document.createElement( 'p' );
			if( 'announcement' in obj ){
				e1.innerHTML = '<em>' + esc(obj.announcement) + '</em>';
			}else if( 'message' in obj ){
				e1.innerHTML = '<b>' + esc(obj.message[0]) + ':</b> ' + esc(obj.message[1]);
			};
			
			/*
			if( obj.message && window.console && console.log ){
				console.log( obj.message[0], obj.message[1] );
			};
			*/

			document.getElementById( 'chat' ).appendChild(e1);
			document.getElementById( 'chat' ).scrollTop = 10000000;
		};
			
		function send( ){
			var val = document.getElementById('text').value;
			socket.send(val);
			message({message: ['you',val] });
			document.getElementById('text').value = '';
		};
		
		function esc( msg ){
			return msg.replace(/</g, '&lt;').replace(/>/g, '&gt;' );
		};
		
		var socket = new io.Socket( null, { port: 8080, rememberTransport: false } );
		socket.connect();
		socket.on( 'message', function( obj ){
			if( 'buffer' in obj ){
				document.getElementById('form').style.display='block';
				document.getElementById('chat').innerHTML='';
				
				for( var i in obj.buffer ){
					message( obj.buffer[i] );
				}
			}else{
				message( obj );
			}
		} );

		socket.on( 'connection', function( ){
			message( {message: ['System', 'Connected']} );
		} );

		socket.on( 'disconnect', function( ){
			message( {message: ['System', 'Disconnected']} );
		} );
		
		socket.on( 'reconnect', function( ){
			message( {message: ['System', 'Reconnected to server']} );
		} );
		
		socket.on( 'reconnecting', function( nextRetry ){
			message( {message: ['System', 'Attempting to re-connect to the server. Next retry in ' + nextRetry + 'ms'] } );
		} );

		socket.on( 'reconnect_failed', function( ){
			message( {message: ['System', 'Reconnected to server FAILED.'] } );
		} );
	</script>
	<h1>network-graph</h1>
	<div id='chat'><p></P></div>
	<form id='form' onSubmit='send(); return false'>
		<input type='text' autocomplete='off' id='text'><input type='submit' value='send'>
	</form>
</body>
</html>
